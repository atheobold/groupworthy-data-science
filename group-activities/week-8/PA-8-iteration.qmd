---
title: "PA 8: The 12 Days of Christmas"
format: 
  html:
    embed-resources: true
    code-tools: true
    toc: true
    number-sections: true
editor: source
execute: 
  error: true
  echo: true
  eval: false
  message: false
  warning: false
---

```{r}
#| label: setup

library(tidyverse)
```

## Introduction 

The song *"12 Days of Christmas"*, written around 1780, tells the tale of many gifts a person receives in the days leading up to Christmas ([link to lyrics](https://en.wikipedia.org/wiki/The_Twelve_Days_of_Christmas_(song)). You may want to listen to the song.

These gifts repeat and compound; on the first day, the narrator receives

    A partridge in a pear tree.

On the twelfth day, they receive

    Twelve Drummers Drumming
    Eleven Pipers Piping
    Ten Lords a Leaping
    Nine Ladies Waiting
    Eight Maids a Milking
    Seven Swans a Swimming
    Six Geese a Laying
    Five Golden Rings
    Four Calling Birds
    Three French Hens
    Two Turtle Doves
    And a Partridge in a Pear Tree

This week, your task will be to write functions that automatically sing this very repetitive song. In the practice activity, we will start by writing two helper functions which we will use in the lab to write a function to sing this entire song.

# Data set

Run the code provided to load in a data set called `xmas` that contains the crucial information about the gifts in the song. We will use this data set to test out our functions as we work on them.

```{r}
#| label: read-in-data

xmas <- read.csv("https://github.com/earobinson95/stat331-calpoly/raw/master/practice-activities/data/xmas.csv") |> 
  janitor::clean_names()
```

While we're at it, let's make a smaller verision of the `xmas` data set. This 
way we can try out our functions on the small version first *before* we test
them on the full data set.

```{r}
#| label: make-small-data-for-testing

xmas_small <- slice_sample(xmas, n = 2)
```

### Advice

1. Your functions can - and should! - reference each other. That is, don't
duplicate code; use earlier, smaller functions inside your larger functions.

2. Don't sweat the small stuff, this activity focuses on learning about 
vectorized and non-vectorized functions **not** on getting the output to look
as nice as possible. 


# Step 1 -- Pluralizing the Gifts 

The gifts in the `xmas` dataset are listed in singular. For example, on day five
the narrator receives "five golden rings", but the entry in the data set for the
gift on day five simply says "ring".

Using the skeleton of the `pluralize_gift()` function, complete the code so that
the function takes a gift and returns the appropriate plural.

Here are some tips for completing this task:

- The gifts on days six (goose) and nine (lady) have unusual pluralization. You
may assume that in other data sets, there will be **no** additional special
cases besides these types. 

- The following small examples may be useful to you:

```{r}
my_names <- c("Kimberly", "Trini", "Jason", "Billy", "Zach", "Tommy")
str_c(my_names, "s", sep = "")
str_replace(my_names, "y$", "ies")
```

- Your  should **absolutely not** "hard-code" anything into this function. For
example, the word "rings" should not appear anywhere in the function. I should
be able to give your function any gift and get back the plural of that gift.

```{r}
#| label: pluralize-gift-function

# Function that takes a noun and makes it plural
# Arguments -- gift -- A string or vector of strings
# Return -- A string or vector of strings with the pluralized words

pluralize_gift <- function(gift){

  # Check if the word ends in a y
  if(str_detect(gift, pattern = "y$")){
    # Replace the y at the end with an ies
    gift <- str_replace(gift, "y$", "ies")
    } 
  # Check for a oo (goose)
  else if(str_detect(gift, pattern = "oo")){ 
    # Replace the oo with a ee
    gift <- str_replace(gift, "oo", "ee")
    } 
  else{
    # Add an s to the end of the gift
    gift <- str_c(gift, "s", sep = "")
    }

  return(gift)

}
```

### Test Your Function

Try your function out on the smaller and then larger gift data set. Consider: is this function *vectorized*? It does not have to be, but you can try it out if
you want!

```{r}
#| label: pluralize-test 

## TESTING ON SMALL DATASET
map_chr(.x = xmas_small$gift_item, 
        .f = ~ pluralize_gift(gift = .x)
        )

## TESTING ON LARGE DATASET
map_chr(.x = xmas$gift_item, 
        .f = ~ pluralize_gift(gift = .x)
        )
```
:::

# Step 2 -- Creating sentences

Write a function called `make_phrase()` that takes as input the necessary information, and returns a phrase. For example,

    make_phrase(day_num   = 4, 
                adjective = "calling",
                item      = "birds",  
                verb      = "",
                location  = "")

should return

    "four calling birds"
    
and

    make_phrase(day_num  = 10, 
                adjective = NA, 
                item      = "lords", 
                verb      = "a-leaping",
                location  = NA
                )

should return

    "ten lords a-leaping"
    
Here are some tips for completing this task:

- You will need to use your `pluralize_gift()` function!


```{r}
#| label: phrase-function

make_phrase <- function(day_num, adjective, item, verb, location) {
  
  ## Step 1: Replace NAs with blank strings
  adjective <- str_replace_na(adjective, replacement = "")
  verb <- str_replace_na(verb, replacement = "")
  location <- str_replace_na(location, replacement = "")

  ## Step 2: Convert numeric day to English day (1 = one, 2 = two)
  day_num <- english::as.english(day_num)
  
  ## Step 3: If the day number is larger than 1, the gift items need pluralized!
  if (){
    gift <- pluralize_gift()
  }
  
  ## Step 4: For the first day, replace day_num with "a" or "an"
  ## "a partridge in a pear tree" OR "an eagle in a nest" 
  if (day_num == 1){
     day_num <- if_else(
      # If the gift starts with a vowel, add "an" to the beginning
      str_detect(gift, pattern = "^[aeiou]"), 
      "an",
      "a")
    }
  
  ## Step 5: Glue all of the pieces together into one string and return!
  phrase <- glue::glue({day_num}, {adjective}, {gift}, {verb}, {location}) 
  # Remove whitespace from start and end, and replace all internal whitespace
  # with a single space.
  phrase <- str_squish(phrase)

  return(phrase)
}
```

### Test Your Function

Let's try your function out on the `xmas_small` data, by making a new variable
containing the daily phrases. Notice I've provided you with code to iterate
through each row of the data set to create a phrase (using your `make_phrase()`
function) with your function's five inputs (`day_num`, `adjective`, `item`,
`verb`, `location`). 

Because your function has more than two inputs, we need to use a function from
the `pmap_XXX()` family. I specifically chose `pmap_chr()` because the output of
the `make_phrase()` function is a character (string). 

```{r}
xmas_small |> 
  mutate(full_phrase = pmap_chr(.l = list(day_num   = day,
                                          adjective = adjective, 
                                          item      = gift_item, 
                                          verb      = verb, 
                                          location  = location
                                          ), 
                                .f = make_phrase
                                )
         )
```

Once you've obtained a successful test on your `xmas_small` dataset, fill in the
necessary inputs to `pmap_chr()` to create a `full_phrase` column in the `xmas`
dataset. 

```{r}
xmas <- xmas |> 
  mutate(full_phrase = pmap_chr(.l = list(day_num   = ______,
                                          adjective = ______, 
                                          item      = ______, 
                                          verb      = ______, 
                                          location  = ______
                                          ), 
                                .f = make_phrase
                                )
         )
```

### Canvas Submission

> Your `full_phrase` column is the answer to this week's Practice Activity.
>
> Copy and paste your `full_phrase` column to show me the phrases you made!

```{r}
xmas |> 
  pull(full_phrase)
```

### If you finished early...

Revise the `pluralize_gift()` function to be a vectorized function! Hint, you 
will need to translate the `if()`. `else if()`, and `else()` code into different
cases for the `case_when()` function. 
